<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basketball Monster - Dashboard with Edit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .form-grid {
            display: grid;
            gap: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .alert-level-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .alert-level-btn {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .alert-level-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .alert-level-btn.active {
            border: 3px solid #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .user-selection {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .user-checkbox {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.2s ease;
        }

        .user-checkbox:hover {
            background: #f7fafc;
        }

        .user-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-code {
            font-weight: 600;
            color: #333;
            font-family: monospace;
        }

        .user-league-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }

        .user-teams-input {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .notification-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }

        .notification-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .notification-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f3f4f6;
            font-weight: 700;
            color: #333;
        }

        td {
            color: #666;
        }

        .code-cell {
            font-family: monospace;
            font-weight: 600;
            color: #333;
        }

        .league-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-registered {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* NEW: Action buttons */
        .action-btn {
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 8px;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #3b82f6;
            color: white;
        }

        .edit-btn:hover {
            background: #2563eb;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .delete-btn-small {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-btn-small:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .notif-card {
            background: #f9fafb;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .notif-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .notif-emoji {
            font-size: 20px;
            margin-right: 8px;
        }

        .notif-badge {
            padding: 4px 10px;
            border-radius: 6px;
            color: white;
            font-size: 11px;
            font-weight: 700;
            margin-right: 12px;
        }

        .notif-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .notif-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .notif-subtitle {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .notif-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #999;
        }

        /* NEW: Modal styles for edit form */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .help-text {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .code-input-help {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏀 Basketball Monster Dashboard</h1>
            <p>Send injury alerts with league count tracking</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">Registered Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValidCodes">0</div>
                <div class="stat-label">Valid Codes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="serverStatus">Checking...</div>
                <div class="stat-label">Server Status</div>
            </div>
        </div>

        <!-- Add Valid Codes Section -->
        <div class="section">
            <div class="section-title">
                <span>Add Valid Codes with League Counts</span>
                <button class="refresh-btn" onclick="loadValidCodes()">↻ Refresh</button>
            </div>

            <div class="help-text">
                💡 <strong>New Feature:</strong> You can now specify how many leagues each user has! 
                Use format: <code>CODE,LEAGUE_COUNT</code> (e.g., ABC123,3 or XYZ789,1)
            </div>

            <form id="addCodesForm" class="form-grid">
                <div class="form-group">
                    <label for="newCodes">Enter Codes (one per line or comma-separated)</label>
                    <textarea 
                        id="newCodes" 
                        placeholder="ABC123,3&#10;XYZ789,1&#10;DEF456,2&#10;&#10;Or: ABC123,3,XYZ789,1,DEF456,2"
                        rows="6"
                    ></textarea>
                    <div class="code-input-help">
                        Format: CODE or CODE,LEAGUE_COUNT<br>
                        Example: ABC123 (defaults to 1 league) or ABC123,3 (3 leagues)
                    </div>
                </div>

                <button type="submit" class="submit-btn">Add Codes</button>
                <div id="addCodesResult" class="notification-result" style="display: none;"></div>
            </form>

            <div id="validCodesList" style="margin-top: 30px;">
                <div class="no-data">Loading...</div>
            </div>
        </div>

        <!-- Send Injury Alert Section -->
        <div class="section">
            <div class="section-title">
                <span>Send Injury Alert</span>
                <button class="refresh-btn" onclick="loadDevices()">↻ Refresh Users</button>
            </div>

            <form id="injuryForm" class="form-grid">
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerText">Title (Player - Team (Positions)) *</label>
                        <input type="text" id="playerText" placeholder="e.g., LeBron James - LAL (SF/PF)" required>
                    </div>

                    <div class="form-group">
                        <label for="injuryTitle">Status *</label>
                        <select id="injuryTitle" required>
                            <option value="">Select status...</option>
                            <option value="Questionable">Questionable</option>
                            <option value="Injured">Injured</option>
                            <option value="Starting">Starting</option>
                            <option value="Note">Note</option>
                            <option value="Doubtful">Doubtful</option>
                            <option value="Out">Out</option>
                            <option value="In Locker Room">In Locker Room</option>
                            <option value="Playing">Playing</option>
                            <option value="Off Injury Report">Off Injury Report</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Alert Level *</label>
                    <div class="alert-level-group">
                        <button type="button" class="alert-level-btn" data-level="low" style="background: #8C8C8C; color: white;">Low</button>
                        <button type="button" class="alert-level-btn" data-level="medium" style="background: #6699FF; color: white;">Medium</button>
                        <button type="button" class="alert-level-btn" data-level="high" style="background: #E68A00; color: white;">High</button>
                        <button type="button" class="alert-level-btn" data-level="monster" style="background: #CC3300; color: white;">🚨 Monster</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="injuryDescription">Additional Details (optional)</label>
                    <textarea id="injuryDescription" placeholder="Additional injury information..."></textarea>
                </div>

                <div class="form-group">
                    <label>Select Recipients *</label>
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                            Select All
                        </label>
                    </div>
                    <div class="user-selection" id="userList">
                        <div class="no-data">Loading users...</div>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="sendBtn" disabled>Send Alert</button>
                <div id="injuryResult" class="notification-result" style="display: none;"></div>
            </form>
        </div>

        <!-- Notification History -->
        <div class="section">
            <div class="section-title">
                <span>Recent Notifications</span>
                <button class="refresh-btn" onclick="loadNotifications()">↻ Refresh</button>
            </div>
            <div id="notificationList">
                <div class="no-data">Loading...</div>
            </div>
        </div>
    </div>

    <!-- NEW: Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Notification</h2>
                <button class="close-btn" onclick="closeEditModal()">×</button>
            </div>

            <form id="editForm" class="form-grid">
                <input type="hidden" id="editAlertId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="editTitle">Title (Player - Team (Positions)) *</label>
                        <input type="text" id="editTitle" placeholder="e.g., LeBron James - LAL (SF/PF)" required>
                    </div>

                    <div class="form-group">
                        <label for="editStatus">Status *</label>
                        <select id="editStatus" required>
                            <option value="">Select status...</option>
                            <option value="Questionable">Questionable</option>
                            <option value="Injured">Injured</option>
                            <option value="Starting">Starting</option>
                            <option value="Note">Note</option>
                            <option value="Doubtful">Doubtful</option>
                            <option value="Out">Out</option>
                            <option value="In Locker Room">In Locker Room</option>
                            <option value="Playing">Playing</option>
                            <option value="Off Injury Report">Off Injury Report</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Alert Level *</label>
                    <div class="alert-level-group">
                        <button type="button" class="alert-level-btn edit-level" data-level="low" style="background: #8c8c8c; color: white;">Low</button>
                        <button type="button" class="alert-level-btn edit-level" data-level="medium" style="background: #6699ff; color: white;">Medium</button>
                        <button type="button" class="alert-level-btn edit-level" data-level="high" style="background: #e68a00; color: white;">High</button>
                        <button type="button" class="alert-level-btn edit-level" data-level="monster" style="background: #cc3300; color: white;">🚨 Monster</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editDetails">Additional Details (optional)</label>
                    <textarea id="editDetails"></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="submit-btn" style="flex: 1;">Save Changes</button>
                    <button type="button" class="submit-btn" onclick="closeEditModal()" 
                            style="background: #6b7280; flex: 1;">Cancel</button>
                </div>

                <div id="editResult" class="notification-result" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script>
        const serverUrl = 'http://localhost:3003';
        let devices = [];
        let selectedAlertLevel = '';
        let editSelectedLevel = '';

        // Status color mapping (from boss's reasonable defaults)
        const STATUS_COLORS = {
            'Questionable': '#6699FFFF',
            'Injured': '#EF4444FF',
            'Starting': '#10B981FF',
            'Note': '#6B7280FF',
            'Doubtful': '#F97316FF',
            'Out': '#DC2626FF',
            'In Locker Room': '#F59E0BFF',
            'Playing': '#059669FF',
            'Off Injury Report': '#3B82F6FF'
        };

        async function loadDevices() {
            try {
                const response = await fetch(`${serverUrl}/api/devices`);
                const data = await response.json();
                
                if (data.success) {
                    devices = data.devices;
                    displayUsers(devices);
                    document.getElementById('totalDevices').textContent = devices.length;
                    updateStats(devices.length, 'Online');
                } else {
                    showError('userList', 'Failed to load devices');
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                showError('userList', 'Server connection failed');
                updateStats(0, 'Offline');
            }
        }

        function displayUsers(users) {
            const userList = document.getElementById('userList');
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<div class="no-data">No registered devices yet. Add valid codes first!</div>';
                return;
            }

            userList.innerHTML = users.map(user => `
                <div class="user-checkbox">
                    <input type="checkbox" value="${user.code}" onchange="checkFormValidity()">
                    <div class="user-info">
                        <span class="user-code">${user.code}</span>
                        ${user.league_count > 1 ? `
                            <span class="user-league-badge">
                                🏀 ${user.league_count} leagues
                            </span>
                        ` : ''}
                    </div>
                    <input 
                        type="text" 
                        class="user-teams-input" 
                        id="teams_${user.code}" 
                        placeholder="Teams affected (optional)"
                    >
                </div>
            `).join('');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.user-checkbox input[type="checkbox"]').forEach(cb => {
                cb.checked = selectAll;
            });
            checkFormValidity();
        }

        function checkFormValidity() {
            const hasSelectedUsers = document.querySelectorAll('.user-checkbox input[type="checkbox"]:checked').length > 0;
            const hasPlayerText = document.getElementById('playerText').value.trim().length > 0;
            const hasInjuryTitle = document.getElementById('injuryTitle').value !== '';
            const hasAlertLevel = selectedAlertLevel !== '';
            
            const isValid = hasSelectedUsers && hasPlayerText && hasInjuryTitle && hasAlertLevel;
            document.getElementById('sendBtn').disabled = !isValid;
        }

        async function loadNotifications() {
            try {
                const response = await fetch(`${serverUrl}/api/notifications?limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    displayNotifications(data.notifications);
                } else {
                    showError('notificationList', 'Failed to load notifications');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                showError('notificationList', 'Server connection failed');
            }
        }

        function displayNotifications(notifications) {
            const list = document.getElementById('notificationList');
            
            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<div class="no-data">No notifications sent yet</div>';
                return;
            }

            list.innerHTML = notifications.map(notif => {
                const emoji = getAlertEmoji(notif.alert_level);
                const badgeColor = getAlertColor(notif.alert_level);
                const showLevelBadge = notif.alert_level.toLowerCase() !== 'medium';
                
                return `
                    <div class="notif-card">
                        <div class="notif-header">
                            <span class="notif-badge" style="background: ${notif.status_color || '#6B7280'};">
                                ${notif.status}
                            </span>
                            ${showLevelBadge ? `
                                <span class="notif-badge" style="background: ${badgeColor};">
                                    ${emoji} ${notif.alert_level.toUpperCase()}
                                </span>
                            ` : ''}
                            <div class="notif-actions">
                                <button class="action-btn edit-btn" onclick='openEditModal(${JSON.stringify(notif).replace(/'/g, "&#39;")})'>
                                    ✏️ Edit
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteNotification('${notif.alert_id}')">
                                    🗑️ Delete
                                </button>
                            </div>
                        </div>
                        <div class="notif-title">${notif.title}</div>
                        ${notif.details ? `
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">
                                ${notif.details}
                            </div>
                        ` : ''}
                        <div class="notif-meta">
                            <span>Sent to ${notif.total_recipients} device(s)</span>
                            <span>${new Date(notif.sent_at).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // NEW: Open edit modal
        function openEditModal(notification) {
            document.getElementById('editAlertId').value = notification.alert_id;
            document.getElementById('editTitle').value = notification.title;
            document.getElementById('editStatus').value = notification.status;
            document.getElementById('editDetails').value = notification.details || '';
            
            // Set the alert level
            editSelectedLevel = notification.alert_level;
            document.querySelectorAll('.edit-level').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.level === notification.alert_level.toLowerCase()) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('editModal').classList.add('active');
        }

        // NEW: Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editResult').style.display = 'none';
            editSelectedLevel = '';
        }

        // NEW: Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const alertId = document.getElementById('editAlertId').value;
            const title = document.getElementById('editTitle').value.trim();
            const status = document.getElementById('editStatus').value;
            const status_color = STATUS_COLORS[status] || '#6B7280FF';
            const alert_level = editSelectedLevel;
            const details = document.getElementById('editDetails').value.trim();
            
            if (!editSelectedLevel) {
                showModalResult(false, 'Please select an alert level');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        status,
                        status_color,
                        alert_level,
                        details
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showModalResult(true, 'Notification updated successfully!');
                    setTimeout(() => {
                        closeEditModal();
                        loadNotifications();
                    }, 1500);
                } else {
                    showModalResult(false, result.error || 'Failed to update notification');
                }
            } catch (error) {
                showModalResult(false, 'Network error. Please check if the server is running.');
            }
        });

        // NEW: Show result in modal
        function showModalResult(success, message) {
            const resultElement = document.getElementById('editResult');
            resultElement.style.display = 'block';
            resultElement.className = `notification-result ${success ? 'notification-success' : 'notification-error'}`;
            resultElement.textContent = success ? `✅ ${message}` : `❌ ${message}`;
        }

        async function loadValidCodes() {
            try {
                const response = await fetch(`${serverUrl}/api/valid-codes`);
                const data = await response.json();
                
                if (data.success) {
                    displayValidCodes(data.codes);
                    document.getElementById('totalValidCodes').textContent = data.total;
                } else {
                    showError('validCodesList', 'Failed to load valid codes');
                }
            } catch (error) {
                console.error('Error loading valid codes:', error);
                showError('validCodesList', 'Server connection failed');
            }
        }

        function displayValidCodes(codes) {
            const codesList = document.getElementById('validCodesList');
            
            if (!codes || codes.length === 0) {
                codesList.innerHTML = '<div class="no-data">No valid codes yet. Add some using the form above!</div>';
                return;
            }

            codesList.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Leagues</th>
                            <th>Created At</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${codes.map(code => {
                            const isRegistered = devices.some(d => d.code === code.code);
                            return `
                                <tr>
                                    <td class="code-cell">${code.code}</td>
                                    <td>
                                        <span class="league-badge">
                                            🏀 ${code.league_count || 1} ${code.league_count === 1 ? 'league' : 'leagues'}
                                        </span>
                                    </td>
                                    <td>${new Date(code.created_at).toLocaleString()}</td>
                                    <td>
                                        ${isRegistered 
                                            ? '<span class="status-badge status-registered">✓ REGISTERED</span>'
                                            : '<span class="status-badge status-pending">⏳ PENDING</span>'
                                        }
                                    </td>
                                    <td>
                                        <button class="delete-btn-small" onclick="deleteCode('${code.code}')">🗑️ Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function getAlertEmoji(level) {
            const emojis = {
                low: 'ℹ️',
                medium: '⚠️',
                high: '🔥',
                monster: '🚨',
                questionable: '❓',
                probable: '🟡',
                doubtful: '🟠',
                out: '❌'
            };
            return emojis[level?.toLowerCase()] || '📢';
        }

        function getAlertColor(level) {
            const colors = {
                low: '#8c8c8c',      // Gray (from boss)
                medium: '#6699ff',   // Blue (from boss)
                high: '#e68a00',     // Orange (from boss)
                monster: '#cc3300'   // Red (from boss)
            };
            return colors[level?.toLowerCase()] || '#667eea';
        }

        function updateStats(deviceCount, status) {
            document.getElementById('totalDevices').textContent = deviceCount;
            const statusElement = document.getElementById('serverStatus');
            statusElement.textContent = status;
            statusElement.style.color = status === 'Online' ? '#10b981' : '#ef4444';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="no-data" style="color: #ef4444;">
                    ❌ ${message}
                </div>
            `;
        }

        function showResult(elementId, success, message) {
            const resultElement = document.getElementById(elementId);
            resultElement.style.display = 'block';
            resultElement.className = `notification-result ${success ? 'notification-success' : 'notification-error'}`;
            resultElement.textContent = success ? `✅ ${message}` : `❌ ${message}`;
            
            setTimeout(() => {
                resultElement.style.display = 'none';
            }, 5000);
        }

        // Alert level selection for main form
        document.querySelectorAll('.alert-level-btn:not(.edit-level)').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.alert-level-btn:not(.edit-level)').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedAlertLevel = this.dataset.level;
                checkFormValidity();
            });
        });

        // NEW: Alert level selection for edit form
        document.querySelectorAll('.edit-level').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.edit-level').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                editSelectedLevel = this.dataset.level;
            });
        });

        // Form inputs
        document.getElementById('playerText').addEventListener('input', checkFormValidity);
        document.getElementById('injuryTitle').addEventListener('change', checkFormValidity);

        // Send alert form
        document.getElementById('injuryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('playerText').value.trim();
            const status = document.getElementById('injuryTitle').value;
            const status_color = STATUS_COLORS[status] || '#6B7280FF';
            const alert_level = selectedAlertLevel;
            const details = document.getElementById('injuryDescription').value.trim();
            
            const selectedUsers = [];
            document.querySelectorAll('.user-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                const code = checkbox.value;
                const teamsInput = document.getElementById(`teams_${code}`);
                const teams_affected = parseInt(teamsInput.value) || 0;
                selectedUsers.push({
                    user_id: code,
                    teams_affected
                });
            });

            if (selectedUsers.length === 0) {
                showResult('injuryResult', false, 'Please select at least one user');
                return;
            }

            if (!selectedAlertLevel) {
                showResult('injuryResult', false, 'Please select an alert level');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/alert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        status,
                        status_color,
                        alert_level,
                        details,
                        users: selectedUsers
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('injuryResult', true, `Sent to ${result.successful} device(s) successfully!`);
                    
                    // Reset form
                    document.getElementById('injuryForm').reset();
                    document.querySelectorAll('.alert-level-btn:not(.edit-level)').forEach(b => b.classList.remove('active'));
                    selectedAlertLevel = '';
                    document.querySelectorAll('.user-checkbox input[type="checkbox"]').forEach(cb => cb.checked = false);
                    document.getElementById('selectAllCheckbox').checked = false;
                    document.querySelectorAll('.user-teams-input').forEach(input => input.value = '0');
                    checkFormValidity();
                    
                    loadNotifications();
                } else {
                    showResult('injuryResult', false, result.error || 'Failed to send alert');
                }
            } catch (error) {
                showResult('injuryResult', false, 'Network error. Please check if the server is running.');
            }
        });

        // Add codes form
        document.getElementById('addCodesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newCodesText = document.getElementById('newCodes').value.trim();
            
            if (!newCodesText) {
                showResult('addCodesResult', false, 'Please enter at least one code');
                return;
            }

            // Split by newlines first to handle each line separately
            const lines = newCodesText.split('\n').map(line => line.trim()).filter(line => line);
            const codes = [];
            
            for (let line of lines) {
                // Split by comma to separate code and league count
                const parts = line.split(',').map(p => p.trim());
                
                if (parts.length === 1) {
                    // Just a code, no league count
                    codes.push({
                        code: parts[0].toUpperCase(),
                        league_count: 1
                    });
                } else if (parts.length === 2) {
                    // Code with league count: "TEST001, 2"
                    const league_count = parseInt(parts[1]);
                    if (!isNaN(league_count) && league_count > 0) {
                        codes.push({
                            code: parts[0].toUpperCase(),
                            league_count: league_count
                        });
                    } else {
                        // If second part isn't a number, treat as two separate codes
                        codes.push({
                            code: parts[0].toUpperCase(),
                            league_count: 1
                        });
                        codes.push({
                            code: parts[1].toUpperCase(),
                            league_count: 1
                        });
                    }
                } else {
                    // Multiple commas - treat each as separate code
                    for (let part of parts) {
                        if (part) {
                            codes.push({
                                code: part.toUpperCase(),
                                league_count: 1
                            });
                        }
                    }
                }
            }

            if (codes.length === 0) {
                showResult('addCodesResult', false, 'Please enter valid codes');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/add-valid-codes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codes })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('addCodesResult', true, 
                        `Added ${result.added} new codes! (${result.skipped} already existed)`);
                    document.getElementById('addCodesForm').reset();
                    loadValidCodes();
                } else {
                    showResult('addCodesResult', false, result.error || 'Failed to add codes');
                }
            } catch (error) {
                showResult('addCodesResult', false, 'Network error. Please check if the server is running.');
            }
        });

        async function deleteNotification(alertId) {
            if (!confirm('Are you sure you want to delete this notification?')) {
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/alerts/${alertId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadNotifications();
                } else {
                    alert('Failed to delete notification');
                }
            } catch (error) {
                alert('Network error');
            }
        }

        async function deleteCode(code) {
            if (!confirm(`Are you sure you want to delete code ${code}?\n\nThis will prevent new registrations with this code.`)) {
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/delete-code/${code}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadValidCodes();
                    alert(`Code ${code} deleted successfully!`);
                } else {
                    alert('Failed to delete code: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error. Please check if the server is running.');
            }
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Initialize
        loadDevices();
        loadNotifications();
        loadValidCodes();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadDevices();
            loadNotifications();
            loadValidCodes();
        }, 30000);
    </script>
</body>
</html>
